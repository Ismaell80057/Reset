<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RESET â€” IsmaÃ«l</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  :root{
    --bg:#0f1216; --card:#171b21; --muted:#8da2b3; --text:#e9f0f7;
    --accent:#4da3ff; --danger:#ff6b6b; --warn:#ffd166; --ok:#8be28b; --line:#243040; --chip:#223042;
  }
  [data-theme="light"]{
    --bg:#f7fbff; --card:#ffffff; --muted:#5b6b78; --text:#0b1a2b;
    --accent:#2b74d8; --danger:#c54242; --warn:#b8860b; --ok:#2c8d2c; --line:#dde7f1; --chip:#eef4fb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,Roboto,Inter,Segoe UI,Helvetica,Arial; background:var(--bg); color:var(--text); }
  header{ position:sticky; top:0; z-index:10; background:rgba(15,18,22,.8); backdrop-filter:blur(10px); border-bottom:1px solid var(--line); }
  [data-theme="light"] header{ background:rgba(255,255,255,.8); }
  .bar{ max-width:1100px; margin:0 auto; display:flex; align-items:center; gap:10px; padding:10px 16px; }
  .logo{font-weight:800; letter-spacing:.5px; font-size:18px}
  .nav{display:flex; gap:8px; flex-wrap:wrap; margin-left:auto}
  .nav button, .icon-btn{
    background:transparent; color:var(--muted); border:1px solid var(--line); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600;
  }
  .nav button.active{ color:var(--text); border-color:var(--accent); background:rgba(77,163,255,.12)}
  main{max-width:1100px; margin:16px auto; padding:12px}
  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
  h2{font-size:18px; margin:4px 0 10px 0}
  h3{font-size:16px; margin:10px 0 8px 0; color:#4da3ff}
  .muted{color:var(--muted); font-size:13px}
  label{display:block; font-weight:600; margin:10px 0 6px}
  input[type=text], input[type=password], input[type=date], input[type=number], textarea, select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:transparent; color:var(--text);
  }
  textarea{min-height:80px; resize:vertical}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .row > *{flex:1}
  .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; border:1px solid var(--line);
    background:transparent; color:var(--text); font-weight:700; cursor:pointer; }
  .btn.primary{border-color:var(--accent); background:rgba(77,163,255,.12)}
  .btn.ok{border-color:var(--ok); background:rgba(139,226,139,.12)}
  .btn.warn{border-color:var(--warn); background:rgba(255,209,102,.12)}
  .btn.danger{border-color:var(--danger); background:rgba(255,107,107,.12)}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--chip); color:#3b6fab; font-size:12px; border:1px solid var(--line)}
  .list{display:grid; gap:10px}
  .item{padding:10px; border:1px solid var(--line); border-radius:12px; background:transparent}
  .kpi{display:flex; gap:10px; flex-wrap:wrap; margin:4px 0 8px}
  .kpi .box{flex:1; min-width:140px; background:transparent; border:1px solid var(--line); padding:10px; border-radius:12px}
  .kpi .big{font-size:22px; font-weight:900}
  .tag{padding:3px 8px; border-radius:999px; background:var(--chip); color:#3b6fab; border:1px solid var(--line); font-size:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
  .small{font-size:12px}
  .table{width:100%; border-collapse:collapse}
  .table th, .table td{border:1px solid var(--line); padding:10px; text-align:left; vertical-align:top}
  .table th{background:transparent}
  .due-0{border-left:4px solid var(--ok)}
  .due-1{border-left:4px solid var(--warn)}
  .due-2{border-left:4px solid var(--danger)}
  .section{padding:6px 10px; border-radius:8px; background:transparent; border:1px dashed var(--line); margin:8px 0; font-weight:800; letter-spacing:.5px; color:#4da3ff}
  .copy{cursor:pointer; border-bottom:1px dashed #7aa8ff}
  .right{display:flex; gap:8px; justify-content:flex-end}
  .hidden{display:none}
  .divider{height:1px; background:var(--line); margin:10px 0}

  /* Login overlay */
  #login{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:var(--bg); z-index:100; }
  #login .card{ max-width:420px; width:92%; }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">RESET â€” IsmaÃ«l</div>
    <div class="nav" id="nav"></div>
    <button class="icon-btn" id="themeBtn" aria-label="Changer de thÃ¨me">ðŸŒ“</button>
  </div>
</header>

<!-- LOGIN -->
<div id="login">
  <div class="card">
    <h2>Connexion</h2>
    <label>Identifiant</label>
    <input id="lu" type="text" placeholder="Ismael">
    <label>Mot de passe</label>
    <input id="lp" type="password" placeholder="Mot de passe">
    <div class="right"><button class="btn ok" onclick="doLogin()">Se connecter</button></div>
    <div id="lockMsg" class="muted small"></div>
  </div>
</div>

<main id="app" class="hidden">
  <section id="Dashboard" class="view">
    <div class="grid">
      <div class="card">
        <h2>Tableau de bord</h2>
        <div class="kpi">
          <div class="box">
            <div class="muted small">Habitudes cochÃ©es aujourdâ€™hui</div>
            <div class="big" id="kpiStreak">0</div>
          </div>
          <div class="box">
            <div class="muted small">EntrÃ©es de journal (30 j)</div>
            <div class="big" id="kpiLogs">0</div>
          </div>
          <div class="box">
            <div class="muted small">TÃ¢ches invisibles faites (30 j)</div>
            <div class="big" id="kpiInvisible">0</div>
          </div>
        </div>
        <div class="row">
          <button class="btn primary" onclick="showView('3R')">Lancer le 3R</button>
          <button class="btn" onclick="showView('Journal')">Note rapide</button>
          <button class="btn" onclick="showView('Habitudes')">Habitudes</button>
          <button class="btn" onclick="showView('Contrat')">Contrat</button>
        </div>
        <div class="divider"></div>
        <div id="contractBadge" class="muted small">Aucun contrat dÃ©fini.</div>
      </div>

      <div class="card">
        <h2>Scripts rapides</h2>
        <div class="list" id="quickScripts"></div>
      </div>
    </div>
  </section>

  <section id="3R" class="view hidden">
    <div class="grid">
      <div class="card">
        <h2>3R â€” Stopper â†’ SÃ©curiser â†’ RÃ©parer</h2>
        <div class="section">1) Stopper</div>
        <div class="row">
          <button class="btn danger" onclick="startPause()">Pause 60s</button>
          <button class="btn" onclick="updateStatus('Inspire 4s / expire 4s Ã— 6')">Resp 4â€“4</button>
          <button class="btn" onclick="updateStatus('Verre dâ€™eau / 30 pas')">Eau / 30 pas</button>
        </div>
        <div class="muted" id="pauseStatus">PrÃªt.</div>

        <div class="section">2) SÃ©curiser (choisis une phrase)</div>
        <div class="list" id="securePhrases"></div>

        <div class="section">3) RÃ©parer (4 lignes)</div>
        <div class="row"><input id="repFait" type="text" placeholder="Fait : jâ€™aiâ€¦"></div>
        <div class="row"><input id="repImpact" type="text" placeholder="Impact : Ã§a tâ€™aâ€¦"></div>
        <div class="row"><input id="repResp" type="text" placeholder="ResponsabilitÃ© : câ€™est pour moi."></div>
        <div class="row"><input id="repRep" type="text" placeholder="RÃ©paration : je proposeâ€¦"></div>
        <div class="right"><button class="btn ok" onclick="saveRepair()">Enregistrer + Journal</button></div>
      </div>

      <div class="card">
        <h2>Pack urgence</h2>
        <div class="list">
          <div class="item"><b>Animal (nuit)</b><br>Â« Je gÃ¨re, dors tranquille. Â» â†’ friandise dedans, refermer, rÃ©essayer 2 min plus tard.</div>
          <div class="item"><b>Tension</b><br>Â« Pause. Je reviens Ã  :15. Â» puis Ã©couter sans couper.</div>
          <div class="item"><b>HALT</b> â†’ Faim / ColÃ¨re / Solitude / Fatigue : traiter avant de parler.</div>
        </div>
      </div>
    </div>
  </section>

  <section id="Journal" class="view hidden">
    <div class="grid">
      <div class="card">
        <h2>Journal rapide</h2>
        <div class="row">
          <div><label>DÃ©clencheur</label><input id="jTrig" type="text" placeholder="chien, critiqueâ€¦"></div>
          <div><label>Ã‰motion (0â€“10)</label><input id="jEmo" type="number" min="0" max="10" value="5"></div>
        </div>
        <label>Ce que jâ€™ai fait / dit</label><textarea id="jDid"></textarea>
        <label>Alternative la prochaine fois</label><textarea id="jAlt"></textarea>
        <div class="right"><button class="btn ok" onclick="saveLog()">Enregistrer</button></div>
      </div>

      <div class="card">
        <h2>Historique</h2>
        <div class="row">
          <select id="filterDays" onchange="renderLogs()">
            <option value="7">7 j</option>
            <option value="30" selected>30 j</option>
            <option value="90">90 j</option>
            <option value="all">Tout</option>
          </select>
          <input id="searchLog" type="text" placeholder="Rechercherâ€¦" oninput="renderLogs()">
        </div>
        <div class="list" id="logList"></div>
      </div>
    </div>
  </section>

  <section id="Habitudes" class="view hidden">
    <div class="grid">
      <div class="card">
        <h2>Habitudes nonâ€‘nÃ©gociables</h2>
        <div id="habitList" class="list"></div>
        <div class="row">
          <input id="habitNew" type="text" placeholder="Ajouter une habitudeâ€¦">
          <button class="btn primary" onclick="addHabit()">Ajouter</button>
        </div>
      </div>
      <div class="card">
        <h2>Progression</h2>
        <div id="habitStats" class="list"></div>
      </div>
    </div>
  </section>

  <section id="Taches" class="view hidden">
    <div class="card">
      <h2>TÃ¢ches par piÃ¨ce</h2>
      <div class="muted small">Couleur Ã  gauche : OK / bientÃ´t dÃ»e / en retard.</div>
      <div id="tasksWrap"></div>
    </div>
  </section>

  <section id="Contrat" class="view hidden">
    <div class="grid">
      <div class="card">
        <h2>Contrat de transformation</h2>
        <label>Mes 3 engagements quotidiens</label>
        <textarea id="cDaily" placeholder="Ex : Ne pas rÃ©veiller Cass â€” GÃ©rer mes frustrations avec 3R â€” 1 tÃ¢che invisibleâ€¦"></textarea>
        <label>Limites & respect</label>
        <textarea id="cLimits" placeholder="Ce que je ne fais plus, ce que je tolÃ¨re / ne tolÃ¨re pasâ€¦"></textarea>
        <label>RÃ©parations en cas de dÃ©rapage</label>
        <textarea id="cRepair" placeholder="Ex : 3R immÃ©diat, 2 actes concrets, message de rÃ©parationâ€¦"></textarea>
        <div class="row">
          <input id="cDate" type="date">
          <input id="cName" type="text" placeholder="SignÃ© par (IsmaÃ«l)">
        </div>
        <div class="right">
          <button class="btn ok" onclick="saveContract()">Enregistrer le contrat</button>
        </div>
      </div>
      <div class="card">
        <h2>Contrat actuel</h2>
        <div id="contractView" class="item muted">Aucun contrat enregistrÃ©.</div>
      </div>
    </div>
  </section>

  <section id="HALT" class="view hidden">
    <div class="grid">
      <div class="card">
        <h2>HALT</h2>
        <div class="row">
          <label><input type="checkbox" id="hHungry"> Faim</label>
          <label><input type="checkbox" id="hAngry"> ColÃ¨re</label>
          <label><input type="checkbox" id="hLonely"> Solitude</label>
          <label><input type="checkbox" id="hTired"> Fatigue</label>
        </div>
        <div class="row">
          <button class="btn primary" onclick="haltAdvice()">Conseil</button>
        </div>
        <div id="haltOut" class="item"></div>
      </div>
      <div class="card">
        <h2>Scripts utiles</h2>
        <div class="list" id="haltScripts"></div>
      </div>
    </div>
  </section>

  <section id="Donnees" class="view hidden">
    <div class="grid">
      <div class="card">
        <h2>DonnÃ©es</h2>
        <div class="row">
          <button class="btn" onclick="downloadData()">Exporter (JSON)</button>
          <label class="btn">Importer JSON <input type="file" accept="application/json" style="display:none" onchange="importData(event)"></label>
          <button class="btn warn" onclick="maybeBackup()">Rappel sauvegarde</button>
          <button class="btn danger" onclick="if(confirm('RÃ©initialiser toutes les donnÃ©es ?')){localStorage.removeItem(VKEY); location.reload();}">RÃ©initialiser</button>
        </div>
        <div class="muted small">Tout est stockÃ© sur cet appareil (localStorage). Aucun envoi en ligne.</div>
      </div>

      <div class="card">
        <h2>Ã‰diteur de scripts rapides</h2>
        <div id="quickEdit"></div>
      </div>
    </div>
  </section>
</main>

<script>
// ====== Login simple ======
function doLogin(){
  const u=document.getElementById('lu').value.trim();
  const p=document.getElementById('lp').value;
  if(u==='Ismael' && p==='Bymemu48.'){
    document.getElementById('login').style.display='none';
    document.getElementById('app').classList.remove('hidden');
    applyTheme(); showView('Dashboard'); renderDashboard();
    window.scrollTo({top:0, behavior:'auto'});
  } else {
    document.getElementById('lockMsg').textContent='Identifiants incorrects.';
  }
}

// ====== App state ======
const VKEY='resetAppDataV1';
const today = () => (new Date()).toISOString().slice(0,10);
const freqToDays = {"Quotidien":1,"Hebdo":7,"2Ã—/semaine":3,"Mensuel":30,"Trimestriel":90,"Semestriel":180};

const defaultData = {
  logs: [],
  habits: [
    { id:'hab1', name:"Ne pas rÃ©veiller Cass pour le chien (je gÃ¨re)", done:{}, active:true },
    { id:'hab2', name:"1 tÃ¢che invisible", done:{}, active:true },
    { id:'hab3', name:"Check-in 5 min (Ã‰tat, Besoin, Merci)", done:{}, active:true },
    { id:'hab4', name:"HALT avant discussion", done:{}, active:true }
  ],
  tasks: {
    "Cuisine": {
      "VISIBLES":[
        {name:"Vaisselle / lave-vaisselle", freq:"Quotidien", last:null},
        {name:"Essuyer plans de travail", freq:"Quotidien", last:null},
        {name:"Nettoyer plaque de cuisson", freq:"Quotidien", last:null},
        {name:"Vider poubelle + nouveau sac", freq:"Quotidien", last:null},
        {name:"Balayer / laver le sol", freq:"2Ã—/semaine", last:null}
      ],
      "INVISIBLES":[
        {name:"IntÃ©rieur micro-ondes", freq:"Hebdo", last:null},
        {name:"IntÃ©rieur du four", freq:"Mensuel", last:null},
        {name:"Hotte (extÃ©rieur + filtre)", freq:"Mensuel", last:null},
        {name:"Tiroirs couverts/ustensiles", freq:"Trimestriel", last:null},
        {name:"IntÃ©rieur des placards", freq:"Trimestriel", last:null},
        {name:"Frigo + congÃ©lateur", freq:"Mensuel", last:null},
        {name:"PoignÃ©es & interrupteurs", freq:"Hebdo", last:null},
        {name:"Dessus meubles & frigo", freq:"Mensuel", last:null}
      ]
    },
    "Salon": {
      "VISIBLES":[
        {name:"Ranger ce qui traÃ®ne", freq:"Quotidien", last:null},
        {name:"Aspirateur", freq:"2Ã—/semaine", last:null},
        {name:"Laver le sol (si besoin)", freq:"Hebdo", last:null},
        {name:"Ã‰pousseter table & meubles", freq:"Hebdo", last:null},
        {name:"Plier plaids / coussins", freq:"Quotidien", last:null}
      ],
      "INVISIBLES":[
        {name:"IntÃ©rieur tiroirs / rangements", freq:"Trimestriel", last:null},
        {name:"DerriÃ¨re TV & appareils", freq:"Mensuel", last:null},
        {name:"Vitres et miroirs", freq:"Mensuel", last:null},
        {name:"PoignÃ©es & interrupteurs", freq:"Hebdo", last:null},
        {name:"Plinthes", freq:"Mensuel", last:null},
        {name:"Aspirer derriÃ¨re meubles", freq:"Mensuel", last:null},
        {name:"Lampes / abat-jour", freq:"Mensuel", last:null}
      ]
    },
    "Chambre": {
      "VISIBLES":[
        {name:"Faire le lit", freq:"Quotidien", last:null},
        {name:"Ranger vÃªtements", freq:"Quotidien", last:null},
        {name:"Aspirateur", freq:"Hebdo", last:null},
        {name:"Ã‰pousseter chevets & commodes", freq:"Hebdo", last:null}
      ],
      "INVISIBLES":[
        {name:"Tiroirs (chevet, commode)", freq:"Trimestriel", last:null},
        {name:"Sous le lit & derriÃ¨re meubles", freq:"Mensuel", last:null},
        {name:"Vitres", freq:"Mensuel", last:null},
        {name:"PoignÃ©es & interrupteurs", freq:"Hebdo", last:null},
        {name:"Rideaux / voilages", freq:"Semestriel", last:null},
        {name:"Plinthes", freq:"Mensuel", last:null}
      ]
    },
    "Salle de bain (WC)": {
      "VISIBLES":[
        {name:"Vasque & plan", freq:"Quotidien", last:null},
        {name:"Miroir", freq:"Hebdo", last:null},
        {name:"Douche/baignoire", freq:"Hebdo", last:null},
        {name:"Sol", freq:"Hebdo", last:null},
        {name:"Poubelle", freq:"Quotidien", last:null}
      ],
      "INVISIBLES":[
        {name:"Placards & tiroirs (intÃ©rieur)", freq:"Trimestriel", last:null},
        {name:"Pommeau de douche (dÃ©tartrer)", freq:"Mensuel", last:null},
        {name:"Rideau/paroi de douche", freq:"Mensuel", last:null},
        {name:"Joints carrelage", freq:"Mensuel", last:null},
        {name:"PoignÃ©es & interrupteurs", freq:"Hebdo", last:null},
        {name:"Panier Ã  linge", freq:"Mensuel", last:null},
        {name:"DerriÃ¨re les WC", freq:"Mensuel", last:null}
      ]
    }
  },
  scripts:[
    "Je mâ€™arrÃªte. Je suis tendu. Je reviens Ã  :10.",
    "Je gÃ¨re. Tu peux dormir tranquille.",
    "Pause. Je reviens Ã  :15.",
    "Je tâ€™Ã©coute. Dis-moi.",
    "Jâ€™ai dÃ©rapÃ©. Câ€™est pour moi. Je rÃ©pare maintenant."
  ],
  contract: null,
  theme: "dark",
  lastBackupPrompt: null
};

let state = JSON.parse(localStorage.getItem(VKEY) || 'null') || defaultData;
function save(){ localStorage.setItem(VKEY, JSON.stringify(state)); renderKPIs(); updateContractBadge(); }

// Navigation
const views=["Dashboard","3R","Journal","Habitudes","Taches","Contrat","HALT","Donnees"];
const nav=document.getElementById('nav');
views.forEach(v=>{ const b=document.createElement('button'); b.textContent=v.replace('Taches','TÃ¢ches'); b.onclick=()=>showView(v); nav.appendChild(b); });
function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  [...document.querySelectorAll('.nav button')].find(b=>b.textContent===id || (id==='Taches' && b.textContent==='TÃ¢ches')).classList.add('active');
  if(id==='Journal') renderLogs();
  if(id==='Habitudes'){ renderHabits(); renderHabitStats(); }
  if(id==='Taches') renderTasks();
  if(id==='Dashboard'){ renderDashboard(); updateContractBadge(); }
  if(id==='HALT') renderHaltScripts();
  if(id==='Donnees') renderQuickEdit();
  if(id==='Contrat') renderContract();
}

// Theme
function applyTheme(){ document.documentElement.setAttribute('data-theme', state.theme==='light'?'light':'dark'); }
applyTheme();
document.getElementById('themeBtn').onclick = ()=>{ state.theme = state.theme==='light'?'dark':'light'; save(); applyTheme(); };

// Dashboard
function renderDashboard(){
  const list=document.getElementById('quickScripts'); list.innerHTML="";
  state.scripts.forEach(s=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<span class="copy" onclick="navigator.clipboard.writeText(\`${s}\`)">${s}</span>`; list.appendChild(d); });
  renderKPIs();
}
function renderKPIs(){
  const t = today();
  document.getElementById('kpiStreak').textContent = String(state.habits.filter(h=>h.done && h.done[t]).length);
  const since = Date.now()-30*86400000;
  document.getElementById('kpiLogs').textContent = String(state.logs.filter(l=>new Date(l.date).getTime()>=since).length);
  let c=0; Object.values(state.tasks).forEach(room=>{
    room["INVISIBLES"].forEach(tk=>{ if(tk.last && new Date(tk.last).getTime()>=since) c++; });
  });
  document.getElementById('kpiInvisible').textContent=String(c);
}

// 3R
function startPause(){ let s=60; const el=document.getElementById('pauseStatus'); el.textContent="Pause 60sâ€¦"; const it=setInterval(()=>{ s--; el.textContent=`Pause ${s}sâ€¦ Respire 4â€“4.`; if(s<=0){clearInterval(it); el.textContent="Pause terminÃ©e.";} },1000); }
function updateStatus(txt){ document.getElementById('pauseStatus').textContent=txt; }
const securePhrases=["Je mâ€™arrÃªte. Je suis tendu. Je reviens Ã  :10.","Je gÃ¨re. Tu peux dormir tranquille.","Pause. Je reviens Ã  :15."];
(function(){ const w=document.getElementById('securePhrases'); securePhrases.forEach(s=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<span class="copy" onclick="navigator.clipboard.writeText(\`${s}\`)">${s}</span>`; w.appendChild(d); }); })();
function saveRepair(){
  const e={date:today(), type:"3R",
    fait:document.getElementById('repFait').value.trim(),
    impact:document.getElementById('repImpact').value.trim(),
    resp:document.getElementById('repResp').value.trim(),
    rep:document.getElementById('repRep').value.trim()
  };
  if(e.fait||e.impact||e.resp||e.rep){ state.logs.unshift(e); save(); alert("AjoutÃ© au journal."); }
}

// Journal
function saveLog(){
  const l={date:today(), trig:document.getElementById('jTrig').value.trim(), emo:+document.getElementById('jEmo').value||0, did:document.getElementById('jDid').value.trim(), alt:document.getElementById('jAlt').value.trim()};
  if(!l.trig && !l.did && !l.alt){ alert("Ã‰cris au moins une info."); return; }
  state.logs.unshift(l); save(); renderLogs();
}
function renderLogs(){
  const list=document.getElementById('logList'); list.innerHTML="";
  const q=(document.getElementById('searchLog')?.value||"").toLowerCase(); const fd=document.getElementById('filterDays')?.value||"30";
  const since = fd==="all" ? 0 : Date.now()-(+fd)*86400000;
  state.logs.filter(l=> new Date(l.date).getTime()>=since).forEach(l=>{
    const text=JSON.stringify(l).toLowerCase(); if(q && !text.includes(q)) return;
    const d=document.createElement('div'); d.className='item';
    let html=`<div class="muted small">${l.date}</div>`;
    if(l.type==="3R"){
      html+=`<b>RÃ©paration 3R</b><br>Fait: ${l.fait||"-"}<br>Impact: ${l.impact||"-"}<br>ResponsabilitÃ©: ${l.resp||"-"}<br>RÃ©paration: ${l.rep||"-"}`;
    } else {
      html+=`<b>DÃ©clencheur:</b> ${l.trig||"-"} | <b>Ã‰motion:</b> ${l.emo}/10<br><b>Jâ€™ai fait/dit:</b> ${l.did||"-"}<br><b>Alternative:</b> ${l.alt||"-"}`;
    }
    d.innerHTML=html; list.appendChild(d);
  });
}

// Habitudes
function renderHabits(){
  const w=document.getElementById('habitList'); w.innerHTML="";
  const t=today();
  state.habits.forEach(h=>{
    if(!h.active) return;
    const it=document.createElement('div'); it.className='item';
    const checked=!!(h.done && h.done[t]);
    it.innerHTML=`<div class="row" style="align-items:center">
      <label style="flex:2"><input type="checkbox" ${checked?'checked':''} onchange="toggleHabit('${h.id}')"> ${h.name}</label>
      <button class="btn" onclick="removeHabit('${h.id}')">Supprimer</button></div>`;
    w.appendChild(it);
  });
}
function toggleHabit(id){ const t=today(); const h=state.habits.find(x=>x.id===id); if(!h.done) h.done={}; if(h.done[t]) delete h.done[t]; else h.done[t]=true; save(); renderHabits(); renderHabitStats(); }
function addHabit(){ const v=document.getElementById('habitNew').value.trim(); if(!v) return; state.habits.push({id:'hab'+Math.random().toString(36).slice(2,8), name:v, done:{}, active:true}); document.getElementById('habitNew').value=""; save(); renderHabits(); }
function removeHabit(id){ if(!confirm("Supprimer ?")) return; state.habits=state.habits.filter(h=>h.id!==id); save(); renderHabits(); }
function renderHabitStats(){ const t=today(); const total=state.habits.filter(h=>h.active).length||1; const done=state.habits.filter(h=>h.active && h.done && h.done[t]).length; const wrap=document.getElementById('habitStats'); wrap.innerHTML=""; const d=document.createElement('div'); d.className='item'; d.innerHTML=`<b>Aujourdâ€™hui :</b> ${done}/${total} nonâ€‘nÃ©gociables faits.`; wrap.appendChild(d); }

// Tasks
function daysBetween(d1,d2){ const a=new Date(d1), b=new Date(d2); return Math.floor((b-a)/86400000); }
function dueClass(last,freq){ if(!last) return 'due-2'; const need=freqToDays[freq]||30; const ago=daysBetween(last,today()); if(ago<=need*0.8) return 'due-0'; if(ago<=need) return 'due-1'; return 'due-2'; }
function renderTasks(){
  const wrap=document.getElementById('tasksWrap'); wrap.innerHTML="";
  Object.keys(state.tasks).forEach(room=>{
    const card=document.createElement('div'); card.className='item'; card.innerHTML=`<h3>${room}</h3>`;
    const tbl=document.createElement('table'); tbl.className='table';
    tbl.innerHTML=`<tr><th>Type</th><th>TÃ¢che</th><th>FrÃ©quence</th><th>Dernier fait</th><th>Action</th></tr>`;
    ["VISIBLES","INVISIBLES"].forEach(sec=>{
      const srow=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=5; td.innerHTML=`<div class="section">${sec}</div>`; srow.appendChild(td); tbl.appendChild(srow);
      state.tasks[room][sec].forEach((t,i)=>{
        const tr=document.createElement('tr'); tr.className=dueClass(t.last,t.freq);
        tr.innerHTML=`<td>${sec.toLowerCase()}</td><td>${t.name}</td><td>${t.freq}</td><td>${t.last||"-"}</td><td><button class="btn ok" onclick="markDone('${room}','${sec}',${i})">Marquer fait</button></td>`;
        tbl.appendChild(tr);
      });
    });
    card.appendChild(tbl); wrap.appendChild(card);
  });
}
function markDone(room,sec,idx){ state.tasks[room][sec][idx].last=today(); save(); renderTasks(); }

// HALT
function haltAdvice(){
  const H=document.getElementById('hHungry').checked, A=document.getElementById('hAngry').checked, L=document.getElementById('hLonely').checked, T=document.getElementById('hTired').checked;
  const out=[]; if(H) out.push("Snack + eau avant de parler."); if(A) out.push("3R puis reformule sans Â« mais Â»."); if(L) out.push("Message Ã  un ami / cÃ¢lin."); if(T) out.push("Sieste 20 min / douche. Pas de discussion tant que la fatigue nâ€™est pas traitÃ©e.");
  document.getElementById('haltOut').textContent = out.length? out.join(' ') : "RAS. Tu peux parler maintenant, en restant sur les faits.";
}
function renderHaltScripts(){ const wrap=document.getElementById('haltScripts'); wrap.innerHTML=""; ["Je mâ€™arrÃªte. Je reviens Ã  :10.","Je gÃ¨re, dors tranquille.","Je tâ€™Ã©coute, dis-moi."].forEach(s=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<span class="copy" onclick="navigator.clipboard.writeText(\`${s}\`)">${s}</span>`; wrap.appendChild(d); }); }

// DonnÃ©es (export/import/quick edit)
function downloadData(){ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='reset_data_'+today()+'.json'; a.click(); state.lastBackupPrompt = today(); save(); }
function importData(ev){ const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ state=JSON.parse(r.result); save(); alert('Import ok'); location.reload(); }catch(e){ alert('Fichier invalide'); } }; r.readAsText(f); }
function renderQuickEdit(){
  const wrap=document.getElementById('quickEdit'); wrap.innerHTML="";
  const sc=document.createElement('div'); sc.className='item';
  sc.innerHTML="<b>Scripts rapides</b><div class='muted small'>Ajoute/retire des phrases prÃªtes.</div>";
  const ul=document.createElement('div'); ul.className='list';
  state.scripts.forEach((s,i)=>{
    const it=document.createElement('div'); it.className='row';
    it.innerHTML=`<input type="text" value="${s.replace(/"/g,'&quot;')}" onchange="editScript(${i}, this.value)">
                  <button class="btn danger" onclick="delScript(${i})">Supprimer</button>`;
    ul.appendChild(it);
  });
  const add=document.createElement('div'); add.className='row';
  add.innerHTML = `<input id="scriptNew" type="text" placeholder="Nouvelle phraseâ€¦">
                   <button class="btn primary" onclick="addScript()">Ajouter</button>`;
  sc.appendChild(ul); sc.appendChild(add);
  wrap.appendChild(sc);
}
function editScript(i, val){ state.scripts[i]=val; save(); renderDashboard(); renderQuickEdit(); }
function delScript(i){ state.scripts.splice(i,1); save(); renderDashboard(); renderQuickEdit(); }
function addScript(){ const v=document.getElementById('scriptNew').value.trim(); if(!v) return; state.scripts.push(v); document.getElementById('scriptNew').value=""; save(); renderDashboard(); renderQuickEdit(); }

// Contrat
function saveContract(){
  state.contract = {
    daily: document.getElementById('cDaily').value.trim(),
    limits: document.getElementById('cLimits').value.trim(),
    repair: document.getElementById('cRepair').value.trim(),
    date: document.getElementById('cDate').value || today(),
    name: document.getElementById('cName').value.trim() || "IsmaÃ«l"
  };
  save(); renderContract(); alert("Contrat enregistrÃ©.");
}
function renderContract(){
  const v=document.getElementById('contractView');
  if(!state.contract){ v.textContent="Aucun contrat enregistrÃ©."; return; }
  const c = state.contract;
  v.innerHTML = `<div class="muted small">${c.date} â€” signÃ© par ${c.name}</div>
    <b>Engagements quotidiens</b><br>${(c.daily||'-').replace(/\n/g,'<br>')}<br><br>
    <b>Limites & respect</b><br>${(c.limits||'-').replace(/\n/g,'<br>')}<br><br>
    <b>RÃ©parations</b><br>${(c.repair||'-').replace(/\n/g,'<br>')}`;
}
function updateContractBadge(){
  const b=document.getElementById('contractBadge');
  if(state.contract){
    b.innerHTML = `Contrat actif â€” <span class="muted small">${state.contract.date}</span>`;
  } else {
    b.textContent = "Aucun contrat dÃ©fini.";
  }
}

// Service worker
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js?v=full3').catch(console.error); }

// Init
document.addEventListener('DOMContentLoaded', ()=>{
  // L'app attend le login pour s'afficher
});
</script>
<script src="console-overlay.js" defer></script>
</body>
</html>
