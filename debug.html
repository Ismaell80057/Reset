<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RESET — Debug & Self‑tests</title>
<style>
  body{font-family:-apple-system,Roboto,Inter,Segoe UI,Helvetica,Arial; background:#0f1216; color:#e9f0f7; margin:0; padding:16px}
  .card{background:#171b21; border:1px solid #243040; border-radius:12px; padding:14px; margin-bottom:12px}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .btn{padding:8px 12px; border:1px solid #243040; background:#223042; border-radius:10px; color:#cfe6ff; font-weight:700; cursor:pointer}
  .ok{color:#8be28b} .warn{color:#ffd166} .bad{color:#ff6b6b}
  table{border-collapse:collapse; width:100%} th,td{border:1px solid #243040; padding:8px; text-align:left}
  code{background:#0b1622; padding:2px 4px; border-radius:6px}
</style>
</head>
<body>
<h1>RESET — Debug & Self‑tests</h1>

<div class="card">
  <h2>Statut</h2>
  <table>
    <tr><th>Navigator</th><td id="ua"></td></tr>
    <tr><th>Service worker</th><td id="sw"></td></tr>
    <tr><th>Manifest</th><td id="mani"></td></tr>
    <tr><th>LocalStorage</th><td id="ls"></td></tr>
    <tr><th>Caches</th><td id="caches"></td></tr>
  </table>
  <div class="row" style="margin-top:8px">
    <button class="btn" onclick="resetSW()">Reset SW</button>
    <button class="btn" onclick="clearLS()">Vider LocalStorage (clé RESET)</button>
  </div>
</div>

<div class="card">
  <h2>Self‑tests (fonctionnels)</h2>
  <div id="out"></div>
  <div class="row" style="margin-top:8px">
    <button class="btn" onclick="runAll()">Lancer tous les tests</button>
  </div>
</div>

<div class="card">
  <h2>Console & erreurs</h2>
  <div id="log"></div>
</div>

<script>
(function(){
  const logEl = document.getElementById('log');
  const orig = { log:console.log, warn:console.warn, error:console.error };
  ['log','warn','error'].forEach(k=>{
    console[k] = (...args)=>{
      orig[k](...args);
      const d=document.createElement('div'); d.textContent = '['+k.toUpperCase()+'] '+args.map(a=> typeof a==='object'? JSON.stringify(a): String(a)).join(' ');
      d.className = k==='error'?'bad':(k==='warn'?'warn':''); logEl.appendChild(d);
    };
  });
})();

function row(str, cls=''){ const d=document.createElement('div'); d.innerHTML = str; if(cls) d.className=cls; return d; }
function ok(s){ return `<span class="ok">✅ ${s}</span>` }
function bad(s){ return `<span class="bad">❌ ${s}</span>` }
function warn(s){ return `<span class="warn">⚠️ ${s}</span>` }

document.getElementById('ua').textContent = navigator.userAgent;
(async()=>{
  try{
    const r=await fetch('manifest.webmanifest'); document.getElementById('mani').innerHTML = r.ok ? ok('manifest chargé') : bad('manifest introuvable');
  }catch(e){ document.getElementById('mani').innerHTML = bad('erreur de chargement'); }
})();

(async()=>{
  if('serviceWorker' in navigator){
    const regs = await navigator.serviceWorker.getRegistrations();
    document.getElementById('sw').innerHTML = regs.length ? ok(regs.length+' SW enregistré(s)') : warn('aucun SW');
  } else {
    document.getElementById('sw').innerHTML = bad('non supporté');
  }
})();

try{
  const testKey='__rst__'+Math.random();
  localStorage.setItem(testKey,'1'); localStorage.removeItem(testKey);
  const size = Object.keys(localStorage).reduce((n,k)=> n + (localStorage[k]?.length||0), 0);
  document.getElementById('ls').innerHTML = ok('ok ('+size+' chars stockés)');
}catch(e){
  document.getElementById('ls').innerHTML = bad('indisponible: '+e);
}

(async()=>{
  if(!('caches' in window)) { document.getElementById('caches').innerHTML=warn('API Cache non dispo'); return; }
  const keys = await caches.keys(); document.getElementById('caches').innerHTML = keys.length ? ok(keys.join(', ')) : warn('vide');
})();

async function resetSW(){
  if ('serviceWorker' in navigator) {
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const r of regs) { await r.unregister(); }
  }
  if (window.caches) {
    const keys = await caches.keys();
    for (const k of keys) { await caches.delete(k); }
  }
  alert('SW & caches réinitialisés. Recharge la page principale.');
}
function clearLS(){
  Object.keys(localStorage).filter(k=>k.toLowerCase().includes('reset')).forEach(k=>localStorage.removeItem(k));
  alert('LocalStorage RESET vidé.');
}

async function testLoginFlow(){
  const okLogin = typeof doLogin==='function' || typeof window.doLogin==='function';
  return okLogin ? ok('méthode login présente (manuel)') : warn('méthode login non trouvée (ouvrir index.html)');
}
async function testHALT(){
  try{
    const r = await fetch('index.html'); const tx = await r.text();
    const hasHALT = tx.includes('HALT') && (tx.includes('hHungry') || tx.includes('HALT</h2>'));
    return hasHALT ? ok('HALT présent dans index.html') : bad('HALT introuvable');
  }catch(e){ return bad('lecture index.html impossible'); }
}
async function testExportImport(){
  try{
    const blob = new Blob([JSON.stringify({test:true})], {type:'application/json'});
    return ok('Export JSON possible (simulé)');
  }catch(e){ return bad('Blob JSON non supporté'); }
}
async function testSW(){
  if(!('serviceWorker' in navigator)) return warn('SW non supporté');
  try{
    const regs=await navigator.serviceWorker.getRegistrations();
    return regs.length ? ok('SW enregistré') : warn('aucun SW');
  }catch(e){ return bad('erreur SW'); }
}

async function runAll(){
  const out=document.getElementById('out'); out.innerHTML='';
  out.appendChild( row('1) Login: '+await testLoginFlow()) );
  out.appendChild( row('2) HALT: '+await testHALT()) );
  out.appendChild( row('3) Export/Import: '+await testExportImport()) );
  out.appendChild( row('4) Service Worker: '+await testSW()) );
  out.appendChild( row('— Termine en vérifiant manuellement Journal/Habitudes/Tâches.', 'muted') );
}
</script>
</body>
</html>
